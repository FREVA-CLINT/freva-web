{% extends "_layouts/menu.html" %}

{% block page_title %}{{ history_object.tool|title }} results - Evaluation System{% endblock %}
{% block page_class %}home-page{% endblock %}
{% block content %}
<!-- This code is taken from http://twitter.github.com/bootstrap/examples/hero.html -->

{% load resulttags %}       
{% load dialogtags %}


    <div class="container">
      <!-- Example row of columns -->
      <div class="row">
	      <div class="col-md-12">
	      	<h1>{{ history_object.tool|capfirst }}</h1>
	      	<p>Analysis from {{ history_object.timestamp|date:"d.m.y H:i:s" }} done by <a href="{% url 'history:history' history_object.uid %}">{{history_object.uid}}</a></p>
	      </div>
      </div>
      <div class="row">
	 	 	<div class="col-md-12">
	 	 		<a class="btn btn-primary" href="{% url 'plugins:setup' history_object.tool history_object.id%}" id="config_button">Edit configuration</a>
	 	 		{% if documentation %}
	 	 			<a class="btn btn-success" href="{{documentation.url}}">Documentation</a>
	 	 		{%endif%}
		 		{% if history_object.status > 2 and history_object.slurm_output != '0'%}
	 	 			
	 			<a class="btn btn-danger mybtn-cancel" id="cancelButton_{{h_item.id}}" onClick="cancelDialog.show({{history_object.id}})">Cancel job</a>
				{# Render a Bootstrap password/cancel dialog #}
	 			{% cancel_dialog %} 	 		
	 	 		{%endif%}
	 	 		
	 			<a class="btn btn-info mybtn-sendmail" id="sendButton_{{h_item.id}}" onClick="$('#sendmail_modal').modal('show')">Share Results</a>
				{# Render a Bootstrap sendmail dialog #}
				{% if request.user == history_object.uid %}
	 			{% sendmail_dialog request.build_absolute_uri request.user.isGuest %}
	 			{% endif %} 	 		
	 	 	</div>
	</div>
	  
<!-- Configuration -->
<div class="panel panel-default" style="margin-top:10px;">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" href="#collapseConfig">
          Configuration
        </a>
      </h4>
    </div><!-- panel-heading -->
    <div id="collapseConfig" class="panel-collapse collapse">
      <div class="panel-body">
   	 	 	<div class="col-md-12">
		 	 	<table class="table col-md-12" id="config_table" style="margin-top:10px;">
		 	 	{% for key,value in history_object.config_dict.items %}
		 	 		<tr>
		 	 			<td>{{key}}:</td>
		 	 			<td>{{value}}</td>
		 	 		</tr>
		 	 	{% endfor %}
		 	 	</table>
	 	 		<a class="btn btn-info" onClick="window.prompt('Copy to clipboard: Ctrl+C, Enter', '{{analyze_command | escapejs}}');" id="copy_button" style="margin-bottom:10px;">Copy analyze command</a>
	 	 	</div>
      </div><!-- panel-body -->
    </div><!-- panel-collapse collapse-->
  </div><!-- panel panel-default-->
	  

<!-- Slurm File -->
<div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" href="#collapseOutput">
          Program&#039;s output
        </a>
      </h4>
    </div><!-- panel-heading -->
    <div id="collapseOutput" class="panel-collapse collapse">
      <div class="panel-body">
      {% if file_content %}
      {% if history_object.status > 2 %}
      <script>
      function doUpdate() {
      
		  var tailServiceUrl = '{% url 'history:tailFile' history_object.id %}';
		  $.ajax({type: "GET", url : tailServiceUrl,
		          success: function (data) {
		             if (!data)
		             {
		                console.log(data)
                        window.location.reload(true)
                     }
		             if (data.length > 0)
		             {
		                var output = '';
		                console.log(data)
		                $.each(data, function(index,value){
		                	output += value;
		                });
		                $("#logOutputDiv").append(output);
		                $('#logOutputDiv').stop().animate({
						  scrollTop: $("#logOutputDiv")[0].scrollHeight
						}, 800);
		             }
		             setTimeout("doUpdate()", 2000);
		           }});
		}
		setTimeout("doUpdate()", 2000);
		</script>
		{% endif %}
      
	      <div class="row">
	        <div class="col-md-12">
	            {% if history_object.status > 2 %}
	          	<p>The tool is still running. Here you can see the output:</p>
	          	{% endif %}
		        <div id="logOutputDiv" class="well well-lg" style="height:450px; overflow-y:scroll; overflow-x: hidden;">
	
		        {% for line in file_content %}
		        
		        	{{line}}<br>
		        
		        {%endfor%}
		        
		        </div>
	        </div>
	      </div>
	      {%else%}
	      </div>
	      <div class="row">
	      	 <div class="col-md-12">
	      	 	<p>Process status is <strong>{{ history_object.status_name }}</strong><br/>Because you did not use batchmode we can't display any information</p>
	      	 </div>
	        
	  	  {%endif%}
	      
	      
      </div><!-- panel-body -->
    </div><!-- panel-collapse collapse-->
  </div><!-- panel panel-default-->

	  
	  	  
<!-- Results -->
<div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" href="#collapseResults">

       {% if history_object.status > 0 %}
         No Results (Process status: {{history_object.status_name}})
       {% else %}
          Results
       {%endif%}
        </a>
      </h4>
    </div><!-- panel-heading -->
    <div id="collapseResults" class="panel-collapse collapse">
      <div class="panel-body">	  
	    <div class="row">	   
	 	 {%if not file_list %}		 	 	
		 	 	{% if history_object.status == history_object.processStatus.finished_no_output %}
		 	 		<div class="col-md-3">
		 	 			<p>There was no output produced!</p>
		 	 		</div>
		 	 		
		 	 		<div class="col-md-3">
		 	 			<p>{{history_object.tool}} produced no plots.</p>
		 	 		</div>
                   <div class="col-md-12">
                   <h2><br>Files created:</h2>
                   <ul >
	                   {{ file_list|unordered_list }}
	               </ul>
	               </div>
               {% endif %}
		 	{%else%}
	   
	        <div class="col-md-12">

	        <ul class="jqueryFileTree">
	        {{ file_list|preview_tree }}
	        </ul>
	        </div>
			{%endif%}
		</div> 
		
      </div><!-- panel-body -->
    </div><!-- panel-collapse collapse-->
  </div><!-- panel panel-default-->

</div>
<script>
	$(document).ready(function() {
		
		$("img").lazyload({
		    effect : "fadeIn",
		    threshold : 200,
		    placeholder: "{{STATIC_URL}}img/loading.gif",
		    //event : "click",
		});

		$('.jqueryFileTree a').on('click', function(target){
			var list_el = $(target.target).parent();
			list_el.toggleClass("expanded");
			list_el.toggleClass("collapsed");
			var next_list = $(target.target).next();	

                        var children = $(next_list.parent()).children();
                        var len = children.length;
			var ret = false;

			if(list_el.hasClass('fancybox'))
				ret = true;

                        for (var i = 0; i < len; i++)
				if(!$(children[i]).hasClass('a')) {
					// ret = true;
					$($(children[i]).children()).toggle();
			}

			
			return ret; //don't activate the link
		});	
		
		$(".fancybox").fancybox({
			openEffect	: 'none',
			closeEffect	: 'none'
		});
		
		{% if request.user != history_object.uid %}
		$('#sendButton_{{h_item.id}}').attr('disabled', true); 
		{% endif %}
		
		{% if "configuration" in collapse %} 
		$('#collapseConfig').collapse();
		{% endif %}
		{% if "output" in collapse %} 
		$('#collapseOutput').collapse();
		{% endif %}
		{% if "results" in collapse %} 
		$('#collapseResults').collapse();
		{% endif %}

	});
</script>

{% endblock %}
