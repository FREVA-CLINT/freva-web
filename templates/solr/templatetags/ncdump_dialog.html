{% load static %} 

   <!-- Modal Passwort Dialog-->
  <div class="modal fade" id="myModalPw" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Enter password</h4>
        </div>
        <div class="modal-body" id="browsefield">
                <div class="alert alert-danger" id="wrongPw"><strong>Wrong password!</strong> Please try again.</div>
                <div class="form-group">
                        <p class="help-block">To start Ncdump you have to re-enter your password</p>
                             <form id="passForm" method="post" action="/" name="passForm">
                                <input id="username" type="text" style="display:none;" name="username">
                                <input id="password_temp" class="form-control" type="password" name="password_temp" style="width: 90%;">
                                <input id="ncdump_file" type="hidden" name="job_id">
                             </form>
                        </div>
        </div>
        <div class="modal-body" id="waitingCancel" style="text-align:center;">

                <p>Please wait!</p><img src="{% get_static_prefix %}img/ajax-loader.gif" />
        </div>
        <div class="modal-body" id="ncdumpResult">

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-primary" name="submitNcdumpBtn" id="submitNcdumpBtn">Start Ncdump</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->



<script>
        var ncdumpDialog;
        ncdumpDialog = ncdumpDialog || (function () {
                return {
                        show: function(id, errormsg=false) {
                                        if(errormsg)
                                                $('#wrongPw').show();
                                        else
                                                $('#wrongPw').hide();
                                        $('#password_temp').focus();
                                        $('#waitingCancel').hide();
                                        $('#ncdumpResult').hide();
                                        $('#browsefield').show();
                                        $('.modal-title').html('Enter password'); 
                                        $('#submitNcdumpBtn').button('enable');
                                        $('#submitNcdumpBtn').button('reset');
                                $('#myModalPw').modal('show');
                                if($('#password_temp').val()!='')
                                   ncdumpDialog.process();
                        },
                        process: function () {
                                $('#waitingCancel').show();
                                $('#browsefield').hide();
                                $('#submitNcdumpBtn').button('loading');
                                var url = '{% url 'solr:ncdump' %}';
                                var data = {'file':$('#ncdump_file').val()};
                                $.ajax({
                                   url: '{% url 'solr:ncdump' %}',
                                   dataType: 'json',
                                   type: 'post',
                                   data: {'file':$('#ncdump_file').val(),'pass':$('#password_temp').val()},   
                                   success: function(data){
                                      $('#ncdumpResult').html(data['ncdump']);
                                      console.log(data['error_msg']);
                                      $('#waitingCancel').hide();
                                      $('#wrongPw').hide();
                                      $('#ncdumpResult').show();
                                      $('#browsefield').hide();
                                      $('.modal-title').html('ncdump -h ' + $('#ncdump_file').val());   
                                   },
                                   error: function(xhr){
                                      console.log(xhr);
                                      if(xhr['responseText']=='AuthenticationException'){
                                         $('#wrongPw').show();
                                         $('#waitingCancel').hide();
                                         $('#browsefield').show();
                                        $('#submitNcdumpBtn').button('reset');  
                                      }
                                   }
                                });
                        },
        
                };
        })();
        // simulate click on submit when enter is pressed
        $('#password_temp').keypress(function (e) {
                if (e.which == 13) {
                        $('#submitNcdumpBtn').click();
                        return false;
                }
        });
        $(document).ready(function(){
                $('#submitNcdumpBtn').on('click',function(){
                        ncdumpDialog.process();
                });
        });
</script>


