{% extends "_layouts/menu.html" %}

{% block page_title %}{{tool.name}} setup - Evaluation System{% endblock %}
{% block page_class %}home-page{% endblock %}
{% block content %}

<script src="{{ STATIC_URL }}js/solr_search.js?{% now "U" %}"></script>

{% load bootstrap3 %}

{# Load CSS and JavaScript #}


{% bootstrap_javascript %}
       


    <div class="container">
      <!-- Example row of columns -->
      <div class="row">
        <div class="col-md-12">
        	<h1>{{tool.name}}</h1>
          <p>{{tool.short_description}}</p>
          <form action="" method="post" name="plugin_form" id="plugin_form">
          	{% csrf_token %}		
			
			{% bootstrap_form form %}
			
	                <a class="btn-lg btn-primary btn-block btn" id="runButton">
	                        Run
	                </a>
		  </form>
        </div>
      </div>
	</div>
  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Select a file</h4>
        </div>
        <div class="modal-body" id="browsefield">
          ...
        </div>
        <div class="modal-footer">
          <input type="hidden" name="senderField" id="senderField" value="">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Select file</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
  
  
  <!-- Modal Solr_search-->
  <div class="modal fade" id="myModal_solr" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Search database</h4>
        </div>
        <div class="modal-body">
          <div class="visual_search"></div>
		
			<div class="files"></div>
			
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="solr_select_file">Select file</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
 
  
{% if restricted_user %} 
 <!-- Modal Guest Dialog-->
  <div class="modal fade" id="guestModal" tabindex="-1" role="dialog" aria-labelledby="guestModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Guest login</h4>
        </div>
        <div class="modal-body" id="guest_text">
          	
        	<div class="form-group">
        		<p class="help-block">Dear Guest,</p>
        		<p class="help-block">you do not have the permissions to start any job.
        		You will be automatically redirected to the history. There you can view
        		example results of the tools available.
        		</p>
			</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Ok</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
 {% else %}	
	
  <!-- Modal Passwort Dialog-->
  <div class="modal fade" id="myModalPw" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Enter password</h4>
        </div>
        <div class="modal-body" id="browsefield">
          	
        	<div class="form-group">
        		<p class="help-block">To schedule the analysis you have to re-enter your password</p>
				{% comment %}
				This form is used to trigger the browsers "save password" function
				It also requires a username field and a submit (method="post") button. 
				The actual submit is supressed with "return false" in $('#submit_analysis').on('click')
				{% endcomment %}
				<form name="passForm" id="passForm" action="/" method="post">
				<input id="username" type="text" name="username" style="display:none;">
				<input id="password_temp" class="form-control" type="password" name="password_temp" style="width: 90%;">
				
			</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submit_analysis">Submit analysis</button>
         </form>
	 </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
{% endif %}

<script>

//Script for serializing the solr form values
function getActiveFacets(facet_to_look,facet_group)
{
    	//var form = $('#plugin_form');
	//console.log(form.serialize());
	
	//console.log(facet_group);
	if(facet_group=='global'){
		var solr_fields = $('input[data-group]');
		var solr_fields_global = {};
	}else{
		var solr_fields = $('input[data-group="'+facet_group+'"]');
		var solr_fields_global = $('input[data-group="global"]');
		//var solr_fields = $.extend(solr_fields1, solr_fields2);
	}
	//console.log(solr_fields);
	var search = '';
	$.each(solr_fields, function(index,value){
		search += facetToQuery(index,value, facet_to_look);	
	});
	$.each(solr_fields_global, function(index,value){
			
		search += facetToQuery(index,value, facet_to_look);
		
	});
	//console.log(search);

	return search;

}

function facetToQuery(index, value, facet_to_look)
{
		var val = $(value).val();
                var facet = $(value).attr('data-facet');
                var multiple = $(value).attr('data-multiple');
                if(val!='' && facet!= facet_to_look)
                {
                        if(multiple=='True')
                        {	
				var search = '';
                                var values = val.split(',');
                                $.each(values, function(i,v){
                                        search += facet+'='+v+'&';
                                });            
				return search; 
                        }else{  
                                return facet+'='+val+'&';
                        }
                }
		return '';

}

// Script for the password modal
// set focus to pw-field
$('#myModalPw').on('shown.bs.modal', function () {
    $('#password_temp').focus();
})

// simulate click on submit when enter is pressed
$('#password_temp').keypress(function (e) {
	if (e.which == 13) {
		$('#submit_analysis').click();
		return false;
  	}
});

$(document).ready(function(){
	getActiveFacets();	

	$('#browsefield').fileTree({
		root : '{{user_home}}',
        script: '{% url 'plugins:dirlist' %}',
        expandSpeed: 100,
        collapseSpeed: 100,
        multiFolder: false
    }, function(file) {
        console.log(file);
		var sender = $('#senderField').val();
		$('#'+sender).val(file);
        $('#myModal').modal('hide');

    });
    
    {% if restricted_user %} 
    $('.btn').attr('disabled', 'disabled'); // {{ disable_buttons }}

    // actually the runbutton is a forwarding
    $('#runButton').removeAttr('disabled');
    $('.tourbtn').removeAttr('disabled');
    $('#runButton').on('click', function(e){
    	$('#guestModal').modal('show');
    	window.location.href="/history";
    }); 
    {% else %}
    $('#runButton').on('click', function(e){
    	$('#myModalPw').modal('show');
    }); 
 
    
    $('#submit_analysis').on('click', function(e){
    	
    	var pw = $('#password_temp').val();
    	
    	$('#id_password_hidden').val(pw);
    	
    	$('#plugin_form').submit();
	return false;    	
    
    });
   {% endif %}
});




</script>


{% endblock %}
