{% load custom_filters %}

<style>
    .select2-container {
        padding: 0px;
    }
</style>

<select class="col-md-12 {{attrs.class}}"
        id="{{name}}"
        name="{{name}}{% if multiple %}[]{% endif %}}"
        {% if multiple %} multiple="multiple"{% endif %}>
    {% if not multiple %}
        <option></option>
    {% endif %}
    {% for key, val in options %}
        {% if multiple %}
            <option value="{{key}}" {% if value and key in value %}selected{% endif %}>{{val}}</option>
        {% else %}
            <option value="{{key}}" {% if val == value %}selected{% endif %}>{{val}}</option>
        {% endif %}
    {% endfor %}
</select>

<script>
    $(document).ready(function() {
        $('#{{name}}').select2({
            placeholder: "Select a {{name}}",
            allowClear: true,
            {% if custom %}
                tags: true,  // Allows custom user input
                tokenSeparators: [',', ' '],  // Optional: allows comma/space to create tags
            {% endif %}
        });

        {% if multiple and value %}
            // Preload custom values (if any) not in options
            const existingKeys = new Set({{ options|dict_keys|safe }});
            const userValues = {{ value|safe }};
            const $select = $('#{{name}}');

            userValues.forEach(function(val) {
                if (!existingKeys.has(val)) {
                    const newOption = new Option(val, val, true, true);
                    $select.append(newOption).trigger('change');
                }
            });
        {% endif %}
    });
</script>
